!function(t,o){var e=function(t,o){this.$element=t,this.options=o,this.locationCity=o.startAdcode,this.locationValue="",this.search=this.createDistrictSearch(),this.placeSearch=this.createPlaceSearch(),this.geo=this.createGeocoder(),this.map=this.attachMap(),this.bindEvent(),this.searchChildsByAdCode(this.options.startAdcode),o.geo&&"object"==typeof o.geo&&o.geo.constructor==Array.prototype.constructor&&(this.updateMap(o.geo),this.locationValue=o.geo.join(","))};e.DEFAULTS={auto:!1,nearRadius:500,map:!1,startAdcode:"100000",locationBtn:".location-btn",search:{subdistrict:1,showbiz:!1},geo:{},onLocationError:t.noop},e.Timer=null,e.prototype.createPlaceSearch=function(){return new o.PlaceSearch},e.prototype.attachMap=function(){var o=this;return!!this.options.map&&t(this.options.map).gaodePlace({placeSearch:o.placeSearch,showInfoWindow:!1,markerDraggable:!0,nearRadius:this.options.nearRadius,onMarkerDragEnd:function(t){o.locationValue=[t.lnglat.getLng(),t.lnglat.getLat()].join(",")}})},e.prototype.updateMap=function(t){this.map&&this.map.gaodePlace("update",t)},e.prototype.bindEvent=function(){var o=this;this.$element.find("select").each(function(){t(this).off("change.gaodearea").on("change.gaodearea",function(){var e=t(this),i=e.find("option:selected"),n=(i.text(),i.val());o.resetChildOptions(e.data("level")),n&&o.searchChildsByAdCode(n)})}),this.$element.find(this.options.locationBtn).click(function(t){t.preventDefault(),o.location()}),this.$element.find("[data-level=address]").keyup(function(){null!=e.Timer&&(clearTimeout(e.Timer),e.Timer=null),setTimeout(function(){o.autoLocation()},1e3)})},e.prototype.autoLocation=function(){this.options.auto&&this.location()},e.prototype.renderOptions=function(o,e){return t.map(o,function(t){var o=e&&t.adcode.toString()==e.toString()?"selected":"";return'<option value="'+t.adcode+'" '+o+">"+t.name+"</option>"}).join("")},e.prototype.createGeocoder=function(){return new o.Geocoder(this.options.geo)},e.prototype.createDistrictSearch=function(){return new o.DistrictSearch(this.options.search)},e.prototype.resetOptions=function(o){var e=this;t.map(o,function(t){e.findByLevel(t).html("")})},e.prototype.searchNearBy=function(t,o){this.map&&this.map.gaodePlace("searchNearInfo",t,o)},e.prototype.resetChildOptions=function(t){"province"==t?this.resetOptions(["city","district","area"]):"city"==t?this.resetOptions(["district","area"]):this.resetOptions(["area"])},e.prototype.findByLevel=function(t){return this.$element.find("[data-level="+t+"]")},e.prototype.searchChildsByAdCode=function(t){var o=this;this.searchDistrict(t,function(t){if(t.length>0){var e=t[0],i=e.center;if("string"==typeof e.citycode&&(o.locationCity=e.citycode),e.districtList&&e.districtList.length>0){i=e.districtList[0].center;var n=e.districtList[0].level,a=o.findByLevel(n);a.html(o.renderOptions(e.districtList,a.data("value"))),a.trigger("change")}o.updateMap({position:[i.lng,i.lat]}),o.locationValue=[i.lng,i.lat].join(",")}})},e.prototype.searchDistrict=function(t,o){var e=this;t&&this.search&&this.search.search(t,function(t,i){"complete"===t&&"OK"===i.info&&"function"==typeof o&&o.call(e,i.districtList)})},e.prototype.getLocation=function(t,o){var e=this;this.geo.setCity(this.locationCity),this.geo.getLocation(t,function(t,i){"complete"===t&&"OK"===i.info&&"function"==typeof o&&o.call(e,i)})},e.prototype.location=function(t){var o=this;if(!t){var e=this.findByLevel("address");e.length>0&&(t=e.val())}t?this.getLocation(t,function(t){if(t.geocodes&&t.geocodes.length>0){var e=t.geocodes[0].location;o.updateMap({position:[e.lng,e.lat]}),o.locationValue=[e.lng,e.lat].join(",")}}):"function"==typeof this.options.onLocationError&&this.options.onLocationError.call(this)},e.prototype.getValues=function(o){var e={location:this.locationValue};this.$element.find("[data-level]").each(function(){var o=t(this),i=o.data("level");if("SELECT"==o[0].tagName){var n=o.find("option:selected");e[i]=n.val(),e[i+"Text"]=n.text()}else e[i]=o.val()}),o.call(this,e)};var i=t.fn.gaodeArea;t.fn.gaodeArea=function(o){var i=Array.prototype.slice.call(arguments,1);return this.each(function(){var n=t(this),a=n.data("map.gaode.area"),r=t.extend(!0,{},e.DEFAULTS,n.data(),"object"==typeof o&&o);a||n.data("map.gaode.area",a=new e(n,r)),a&&"string"==typeof o&&a[o].apply(a,i)})},t.fn.gaodeArea.Constructor=e,t.fn.gaodeArea.noConflict=function(){return t.fn.gaodeArea=i,this},t(window).on("load",function(){t("[data-gaode-area]").gaodeArea()})}(jQuery,AMap),function(t,o){var e=function(e,i){this.element=t(e),this.options=i,this.map=new o.Map(e,i.map),this.marker=this.createMarker(),this.infoWindow=this.createMarkerInfoWindow(),this.nearBox=this.createNearBox(),this.search=this.createPlaceSearch(i.placeSearch),this.search.setType(this.options.searchType),this.update(this.options),this.updatePlace()};e.DEFAULTS={map:{resizeEnable:!0,zoom:13},showInfoWindow:!0,nearSize:5,nearRadius:500,markerDraggable:!1,searchType:"交通设施服务|风景名胜|教文化服务",onMarkerDragEnd:t.noop,onMarkerClick:t.noop,placeSearch:null},e.prototype.getOptions=function(){return this.options},e.prototype.resetZoom=function(){this.map.setZoom(this.options.map.zoom)},e.prototype.resetMapCenter=function(t){this.resetZoom(),this.map.setCenter(new o.LngLat(t[0],t[1])),this.options.position=t},e.prototype.createMarker=function(){var t=new o.Marker({map:this.map,position:this.map.getCenter(),draggable:this.options.markerDraggable});return this.options.markerDraggable&&("function"==typeof this.options.onMarkerDragEnd&&t.on("dragend",this.options.onMarkerDragEnd),"function"==typeof this.options.onMarkerClick&&t.on("click",this.options.onMarkerClick)),t},e.prototype.getMarkerPosition=function(){return this.marker.getPosition()},e.prototype.resetMarkerPosition=function(t){this.marker.setPosition(t)},e.prototype.createMarkerInfoWindow=function(){return!!this.options.showInfoWindow&&new o.InfoWindow({isCustom:!0,offset:new o.Pixel(0,-40)})},e.prototype.createNearBox=function(){return this.options.nearBox?t(this.options.nearBox):null},e.prototype.createPlaceSearch=function(t){return null!=t?t:new o.PlaceSearch},e.prototype.renderNearInfo=function(t){var o=parseInt(this.options.nearSize),e="";for(var i in t){if(i>o)break;var n=t[i].name,a=parseInt(t[i].distance),r="米";a>1e3&&(a=(a/=1e3).toFixed(2),r="公里"),e+='<div class="item"><div class="item-heading">'+n+'</div><div class="item-content text-gray">驾车距离 <span class="text-red">'+a+"</span> "+r+"</div></div>"}return e},e.prototype.searchNearPosition=function(t,o){var e=this;this.searchNearInfo(t,function(t){o.html(e.renderNearInfo(t))})},e.prototype.updateWithoutPosition=function(t,o){var e=this;this.searchInfo(o+" "+t,function(i){if(i.length>0){var n=i[0].location;lng=n.lng,lat=n.lat,e.updateWithPosition([n.lng,n.lat],t,o)}})},e.prototype.searchNearInfo=function(t,o){var e=this;t&&this.search&&this.search.searchNearBy(t,this.map.getCenter(),this.options.nearRadius,function(t,i){"complete"===t&&"OK"===i.info&&"function"==typeof o&&o.call(e,i.poiList.pois)})},e.prototype.searchInfo=function(t,o){var e=this;t&&this.search&&this.search.search(t,function(t,i){"complete"===t&&"OK"===i.info&&"function"==typeof o&&o.call(e,i.poiList.pois)})},e.prototype.searchBearBy=function(){var o=this;this.nearBox&&this.nearBox.find("[data-near-info]").each(function(){var e=t(this),i=e.data("near-info");o.searchNearPosition(i,e)})},e.prototype.openMarkerInfoWindow=function(){this.infoWindow&&this.infoWindow.open(this.map,this.marker.getPosition()),this.searchBearBy()},e.prototype.closeMarkerInfoWindow=function(){this.map.clearInfoWindow()},e.prototype.updateMarkerInfo=function(t,o){if(this.infoWindow){var e=['<div class="popover top" style="display:block;position:relative;">'];e.push('<div class="arrow" style="left:50%;bottom:-10px;"></div>'),e.push('<h3 class="popover-title"><strong>'+t+"</strong></h3>"),e.push('<div class="popover-content"><strong>地址：</strong>'+o+"</div>"),e.push("</div>"),this.infoWindow.setContent(e.join("")),this.openMarkerInfoWindow(),this.options.name=t,this.options.addr=o}},e.prototype.update=function(t){this.canUpdate(t)?this.updateWithPosition(t.position,t.name,t.addr):this.canUpdateWithoutPosition(t)&&this.updateWithoutPosition(t.name,t.addr)},e.prototype.updateWithPosition=function(t,e,i){this.resetMapCenter(t),this.resetMarkerPosition(new o.LngLat(t[0],t[1])),this.updateMarkerInfo(e,i)},e.prototype.canUpdate=function(t){return"object"==typeof t.position&&2==t.position.length},e.prototype.canUpdateWithoutPosition=function(t){return t.name||t.addr},e.prototype.updatePlace=function(){var o=this;this.options.hotelsBox&&t(this.options.hotelsBox).on("mouseover"," [data-map-info]",function(){o.update(t(this).data())})};var i=t.fn.gaodePlace;t.fn.gaodePlace=function(o){var i=Array.prototype.slice.call(arguments,1);return this.each(function(){var n=t(this),a=n.data("map.gaode.place"),r=t.extend(!0,{},e.DEFAULTS,n.data(),"object"==typeof o&&o);a||n.data("map.gaode.place",a=new e(this,r)),a&&"string"==typeof o&&a[o].apply(a,i)})},t.fn.gaodePlace.Constructor=e,t.fn.gaodePlace.noConflict=function(){return t.fn.gaodePlace=i,this},t(window).on("load",function(){t("[data-gaode-place]").gaodePlace()})}(jQuery,AMap);